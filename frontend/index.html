<!DOCTYPE html>
<html>
<head>
  <title>Anonymous Doubt Solver</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
    .container { max-width: 900px; margin: 0 auto; }
    .header { text-align: center; color: white; margin-bottom: 40px; }
    .header h1 { font-size: 2.5em; margin-bottom: 10px; }
    .form-section { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); margin-bottom: 30px; }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #333; }
    .form-group input { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 5px; font-size: 1em; transition: border-color 0.3s; }
    .form-group input:focus { outline: none; border-color: #667eea; }
    .btn { padding: 12px 24px; border: none; border-radius: 5px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
    .btn-primary { background: #667eea; color: white; width: 100%; font-size: 1.1em; }
    .btn-primary:hover { background: #5568d3; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); }
    .btn-small { padding: 8px 16px; font-size: 0.9em; margin-left: 10px; }
    .btn-ai { background: #4CAF50; color: white; }
    .btn-ai:hover { background: #45a049; }
    .btn-answer { background: #2196F3; color: white; }
    .btn-answer:hover { background: #0b7dda; }
    .doubts-section { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
    .doubts-section h2 { margin-bottom: 20px; color: #333; }
    .doubt-item { background: #f9f9f9; padding: 20px; margin-bottom: 15px; border-left: 4px solid #667eea; border-radius: 5px; transition: all 0.3s; }
    .doubt-item:hover { box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
    .doubt-question { font-weight: 600; font-size: 1.1em; color: #333; margin-bottom: 8px; }
    .doubt-subject { display: inline-block; background: #667eea; color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.85em; margin-bottom: 10px; }
    .doubt-actions { margin-top: 12px; }
    .answer-section { margin-top: 20px; background: #f0f7ff; padding: 15px; border-radius: 5px; }
    .answer-item { background: white; padding: 12px; margin-top: 10px; border-left: 3px solid #2196F3; border-radius: 3px; }
    .answer-content { margin: 5px 0; color: #555; }
    .ai-answer { border-left-color: #4CAF50; }
    .user-answer { border-left-color: #FF9800; }
    .empty-state { text-align: center; color: #999; padding: 40px; }
    .success-msg { background: #d4edda; color: #155724; padding: 12px; border-radius: 5px; margin-bottom: 15px; display: none; }
  </style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>‚ùì Anonymous Doubt Solver</h1>
    <p>Ask anything anonymously, get AI-powered answers</p>
  </div>

  <div class="form-section">
    <h2>Ask Your Doubt</h2>
    <div class="success-msg" id="successMsg">‚úì Doubt submitted successfully!</div>
    <div class="form-group">
      <label for="question">Your Question</label>
      <input id="question" type="text" placeholder="What would you like to know?">
    </div>
    <div class="form-group">
      <label for="subject">Subject</label>
      <input id="subject" type="text" placeholder="e.g., Mathematics, Science, General...">
    </div>
    <button class="btn btn-primary" onclick="askDoubt()">Submit Doubt</button>
  </div>

  <div class="doubts-section">
    <h2>üìö All Doubts</h2>
    <div id="doubts" class="empty-state">No doubts yet. Be the first to ask!</div>
  </div>
</div>

<script>
const API = window.location.origin;

async function askDoubt() {
  const question = document.getElementById("question").value.trim();
  const subject = document.getElementById("subject").value.trim();
  
  if (!question || !subject) {
    alert("Please fill in all fields");
    return;
  }

  try {
    const res = await fetch(API + "/doubts", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({question, subject})
    });
    
    if (res.ok) {
      document.getElementById("question").value = "";
      document.getElementById("subject").value = "";
      const msg = document.getElementById("successMsg");
      msg.style.display = "block";
      setTimeout(() => msg.style.display = "none", 3000);
      loadDoubts();
    }
  } catch (e) {
    alert("Error submitting doubt: " + e.message);
  }
}

async function loadDoubts() {
  try {
    const res = await fetch(API + "/doubts");
    const doubts = await res.json();

    const ul = document.getElementById("doubts");
    
    if (doubts.length === 0) {
      ul.innerHTML = '<div class="empty-state">No doubts yet. Be the first to ask!</div>';
      return;
    }

    ul.innerHTML = "";
    doubts.forEach(d => {
      const div = document.createElement("div");
      div.className = "doubt-item";
      div.innerHTML = `
        <div class="doubt-question">${d.question}</div>
        <span class="doubt-subject">${d.subject}</span>
        <div class="doubt-actions">
          <button class="btn btn-small btn-ai" onclick="getAI('${d.id}')">ü§ñ Get AI Answer</button>
          <button class="btn btn-small btn-answer" onclick="showAnswers('${d.id}')">üí¨ View Answers</button>
        </div>
        <div class="answer-section" id="answers-${d.id}" style="display:none;"></div>
      `;
      ul.appendChild(div);
    });
  } catch (e) {
    console.error("Error loading doubts:", e);
  }
}

async function getAI(id) {
  try {
    console.log("Calling AI for doubt:", id);
    const res = await fetch(API + "/auto-answer/" + id, {method: "POST"});
    if (res.ok) {
      const result = await res.json();
      console.log("AI answer created:", result);
      alert("‚úì AI has provided an answer!");
      // Wait a moment then show answers
      await new Promise(r => setTimeout(r, 800));
      console.log("Now calling showAnswers");
      await showAnswers(id);
      console.log("showAnswers completed");
    } else {
      console.error("Failed to get AI answer:", res.status);
      alert("Error generating AI answer");
    }
  } catch (e) {
    console.error("Error:", e);
    alert("Error: " + e.message);
  }
}

async function showAnswers(id) {
  try {
    console.log("=== showAnswers START for id:", id);
    
    const container = document.getElementById("answers-" + id);
    console.log("Container found:", !!container, "Element:", container);
    
    if (!container) {
      console.error("CONTAINER NOT FOUND with id: answers-" + id);
      // List all elements with answer-section
      const allSections = document.querySelectorAll(".answer-section");
      console.log("Found " + allSections.length + " answer-sections total");
      allSections.forEach((sec, idx) => console.log("  " + idx + ":", sec.id));
      return;
    }
    
    console.log("Fetching answers from API...");
    const res = await fetch(API + "/answers/" + id);
    
    if (!res.ok) {
      console.error("API error:", res.status, res.statusText);
      return;
    }
    
    const answers = await res.json();
    console.log("Answers from API:", answers);
    
    // Check current state
    const isVisible = container.style.display !== "none" && container.style.display !== "";
    console.log("Container currently visible:", isVisible);
    
    // Force show
    if (!answers || answers.length === 0) {
      console.log("No answers, showing empty state");
      container.innerHTML = "<p style='color:#999; padding: 10px;'>No answers yet.</p>";
    } else {
      console.log("Rendering " + answers.length + " answers");
      let html = "";
      answers.forEach((a, idx) => {
        console.log("Answer " + idx + ":", a.is_ai ? "AI" : "User", a.content.substring(0, 50));
        html += `
          <div class="answer-item ${a.is_ai ? 'ai-answer' : 'user-answer'}">
            <strong>${a.is_ai ? 'ü§ñ AI Answer' : 'üë§ User Answer'}</strong>
            <div class="answer-content" style="white-space: pre-wrap;">${a.content}</div>
            <small>üëç ${a.votes || 0} votes</small>
          </div>
        `;
      });
      container.innerHTML = html;
    }
    
    // Always show it
    container.style.display = "block";
    console.log("Container display set to block");
    console.log("=== showAnswers END");
    
  } catch (e) {
    console.error("ERROR in showAnswers:", e);
    alert("Error: " + e.message);
  }
}

loadDoubts();
setInterval(loadDoubts, 5000); // Refresh every 5 seconds
</script>

</body>
</html>
